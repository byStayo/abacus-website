<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Portfolio Balancer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        .container { max-width: 500px; margin: 0 auto; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .back-link { color: #7d8590; text-decoration: none; font-size: 14px; }
        .back-link:hover { color: #58a6ff; }
        h1 { font-size: 24px; font-weight: 600; color: #e6edf3; }

        /* Animations */
        @keyframes bounce { 0%,100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes glow { 0%,100% { box-shadow: 0 0 5px var(--glow-color); } 50% { box-shadow: 0 0 20px var(--glow-color), 0 0 40px var(--glow-color); } }
        @keyframes rainbow {
            0% { box-shadow: 0 0 20px #ff0000; }
            16% { box-shadow: 0 0 20px #ff8800; }
            33% { box-shadow: 0 0 20px #ffff00; }
            50% { box-shadow: 0 0 20px #00ff00; }
            66% { box-shadow: 0 0 20px #0088ff; }
            83% { box-shadow: 0 0 20px #8800ff; }
            100% { box-shadow: 0 0 20px #ff0000; }
        }
        @keyframes shake { 0%,100% { transform: translateX(0); } 20% { transform: translateX(-5px); } 40% { transform: translateX(5px); } 60% { transform: translateX(-5px); } 80% { transform: translateX(5px); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes confettiFall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(400px) rotate(720deg); opacity: 0; }
        }
        @keyframes flash { 0% { opacity: 0.5; } 100% { opacity: 0; } }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes countUp { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            border-radius: 2px;
            pointer-events: none;
            z-index: 1000;
            animation: confettiFall 1.5s ease-out forwards;
        }

        .screen-flash {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 999;
            animation: flash 0.4s ease-out forwards;
        }
        .screen-flash.good { background-color: rgba(63, 185, 80, 0.4); }
        .screen-flash.ok { background-color: rgba(210, 153, 34, 0.4); }
        .screen-flash.bad { background-color: rgba(248, 81, 73, 0.4); }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .stat {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s;
        }
        .stat.highlight { animation: bounce 0.4s ease; }
        .stat-label { font-size: 11px; color: #7d8590; text-transform: uppercase; margin-bottom: 4px; }
        .stat-value { font-size: 20px; font-weight: 700; }
        .stat-value.green { color: #3fb950; }
        .stat-value.blue { color: #58a6ff; }
        .stat-value.orange { color: #d29922; }

        .timer-bar {
            height: 10px;
            background-color: #21262d;
            border-radius: 5px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #3fb950, #58a6ff);
            border-radius: 5px;
            transition: width 0.1s linear;
        }
        .timer-fill.warning { background: linear-gradient(90deg, #d29922, #f0883e); }
        .timer-fill.danger { background: linear-gradient(90deg, #f85149, #da3633); animation: pulse 0.3s infinite; }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        .chart-box {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s;
        }
        .chart-box.match { border-color: #3fb950; box-shadow: 0 0 20px rgba(63, 185, 80, 0.3); }
        .chart-title {
            font-size: 12px;
            color: #7d8590;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .accuracy-section {
            background-color: #161b22;
            border: 2px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            text-align: center;
            transition: all 0.3s;
        }
        .accuracy-section.perfect {
            border-color: #3fb950;
            animation: rainbow 2s linear infinite;
        }
        .accuracy-section.close { border-color: #d29922; }
        .accuracy-label { font-size: 12px; color: #7d8590; margin-bottom: 8px; }
        .accuracy-value {
            font-size: 56px;
            font-weight: 800;
            transition: all 0.2s;
        }
        .accuracy-value.low { color: #f85149; }
        .accuracy-value.medium { color: #d29922; }
        .accuracy-value.high { color: #3fb950; }
        .accuracy-value.perfect {
            color: #3fb950;
            text-shadow: 0 0 20px rgba(63, 185, 80, 0.5);
        }
        .accuracy-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 8px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .accuracy-badge.show { opacity: 1; transform: scale(1); }
        .accuracy-badge.perfect { background: linear-gradient(135deg, #238636, #3fb950); color: white; }
        .accuracy-badge.close { background: linear-gradient(135deg, #9e6a03, #d29922); color: white; }
        .accuracy-bar {
            height: 8px;
            background-color: #21262d;
            border-radius: 4px;
            margin-top: 12px;
            overflow: hidden;
        }
        .accuracy-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.2s, background-color 0.3s;
        }

        .sliders-section {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .slider-row:last-child { margin-bottom: 0; }
        .slider-row.on-target {
            background-color: rgba(63, 185, 80, 0.1);
            --glow-color: #3fb950;
            animation: glow 1s infinite;
        }
        .slider-row.close-target {
            background-color: rgba(210, 153, 34, 0.1);
        }
        .slider-color {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            flex-shrink: 0;
            transition: transform 0.2s;
        }
        .slider-row.on-target .slider-color { transform: scale(1.2); }
        .slider-label {
            width: 85px;
            font-size: 13px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .slider-container {
            flex: 1;
            position: relative;
        }
        .slider-target-marker {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background-color: #ffffff;
            border-radius: 2px;
            opacity: 0.7;
            z-index: 1;
            pointer-events: none;
        }
        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
            position: relative;
            z-index: 2;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 10px;
            background: linear-gradient(to right, var(--color) var(--value), #21262d var(--value));
            border-radius: 5px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #e6edf3;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: transform 0.15s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        input[type="range"]::-moz-range-track {
            height: 10px;
            background: #21262d;
            border-radius: 5px;
        }
        input[type="range"]::-moz-range-progress {
            height: 10px;
            background: var(--color);
            border-radius: 5px;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #e6edf3;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .slider-values {
            display: flex;
            justify-content: flex-end;
            width: 70px;
            flex-shrink: 0;
            font-size: 13px;
            gap: 4px;
        }
        .slider-current { font-weight: 700; color: #e6edf3; min-width: 28px; text-align: right; }
        .slider-target-val { color: #7d8590; }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #238636, #2ea043);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 18px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .submit-btn::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            pointer-events: none;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(35, 134, 54, 0.4); }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(13, 17, 23, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .overlay.active { display: flex; }
        .overlay-content { text-align: center; padding: 20px; animation: slideUp 0.4s ease; }
        .overlay-title { font-size: 36px; font-weight: 800; margin-bottom: 8px; }
        .overlay-title.win { color: #3fb950; }
        .overlay-title.lose { color: #f85149; }
        .overlay-subtitle { font-size: 18px; color: #7d8590; margin-bottom: 24px; }
        .play-btn {
            background: linear-gradient(135deg, #238636, #2ea043);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .play-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(35, 134, 54, 0.4); }

        .round-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 64px;
            font-weight: 800;
            z-index: 50;
            text-shadow: 0 4px 20px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        .round-result.show { animation: pop 0.5s ease forwards; }
        .round-result.good { color: #3fb950; }
        .round-result.ok { color: #d29922; }
        .round-result.bad { color: #f85149; }

        .combo-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8957e5, #a371f7);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 16px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
        }
        .combo-display.show { opacity: 1; transform: scale(1); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="position:absolute;top:20px;left:20px;display:flex;align-items:center;gap:8px;font-size:14px;"><a href="/" style="color:#7d8590;text-decoration:none;">Abacus</a><span style="color:#7d8590;opacity:0.5;">/</span><a href="/" style="color:#7d8590;text-decoration:none;">Games</a><span style="color:#7d8590;opacity:0.5;">/</span><span style="color:#e6edf3;">Portfolio Balancer</span></div>
            <h1>Portfolio Balancer</h1>
        </header>

        <div class="stats">
            <div class="stat" id="score-stat">
                <div class="stat-label">Score</div>
                <div class="stat-value green" id="score">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Round</div>
                <div class="stat-value blue" id="round">1/10</div>
            </div>
            <div class="stat">
                <div class="stat-label">Best</div>
                <div class="stat-value orange" id="best">0</div>
            </div>
        </div>

        <div class="timer-bar">
            <div class="timer-fill" id="timer" style="width: 100%;"></div>
        </div>

        <div class="charts-section">
            <div class="chart-box" id="current-box">
                <div class="chart-title">Your Allocation</div>
                <canvas id="current-chart" width="120" height="120"></canvas>
            </div>
            <div class="chart-box" id="target-box">
                <div class="chart-title">Target</div>
                <canvas id="target-chart" width="120" height="120"></canvas>
            </div>
        </div>

        <div class="accuracy-section" id="accuracy-section">
            <div class="accuracy-label">ACCURACY</div>
            <div class="accuracy-value high" id="accuracy">100%</div>
            <div class="accuracy-badge" id="accuracy-badge">PERFECT!</div>
            <div class="accuracy-bar">
                <div class="accuracy-fill" id="accuracy-bar" style="width: 100%; background-color: #3fb950;"></div>
            </div>
        </div>

        <div class="sliders-section" id="sliders"></div>

        <button class="submit-btn" id="submit-btn">Lock In Allocation</button>
    </div>

    <div class="round-result" id="round-result">+100</div>
    <div class="combo-display" id="combo-display">ðŸŽ¯ x2 Combo!</div>

    <div class="overlay active" id="start-overlay">
        <div class="overlay-content">
            <div class="overlay-title" style="color: #e6edf3;">Portfolio Balancer</div>
            <div class="overlay-subtitle">Match the target allocation<br>Faster = More points!</div>
            <button class="play-btn" id="start-btn">Start Game</button>
        </div>
    </div>

    <div class="overlay" id="gameover-overlay">
        <div class="overlay-content">
            <div class="overlay-title" id="gameover-title">Game Over</div>
            <div class="overlay-subtitle" id="gameover-subtitle">Final Score: 0</div>
            <button class="play-btn" id="restart-btn">Play Again</button>
        </div>
    </div>

    <script>
        // Audio System
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioCtx();
        }

        function playTone(freq, duration = 0.1, type = 'sine', volume = 0.3) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(volume, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain).connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playSuccess() {
            playTone(523, 0.1);
            setTimeout(() => playTone(659, 0.1), 80);
            setTimeout(() => playTone(784, 0.15), 160);
        }

        function playPerfect() {
            playTone(523, 0.08);
            setTimeout(() => playTone(659, 0.08), 60);
            setTimeout(() => playTone(784, 0.08), 120);
            setTimeout(() => playTone(1046, 0.15), 180);
        }

        function playTick() {
            playTone(800 + Math.random() * 400, 0.03, 'sine', 0.1);
        }

        function playError() {
            playTone(200, 0.15, 'sawtooth', 0.2);
        }

        function playClick() {
            playTone(600, 0.05, 'sine', 0.2);
        }

        // Visual Effects
        function confetti(count = 50) {
            const colors = ['#3fb950', '#58a6ff', '#d29922', '#f0883e', '#a371f7', '#f85149'];
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'confetti';
                particle.style.left = (Math.random() * window.innerWidth) + 'px';
                particle.style.top = '-20px';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.animationDelay = (Math.random() * 0.5) + 's';
                particle.style.animationDuration = (1 + Math.random()) + 's';
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 2000);
            }
        }

        function screenFlash(type) {
            const flash = document.createElement('div');
            flash.className = 'screen-flash ' + type;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 400);
        }

        const ASSET_CLASSES = [
            { name: 'Stocks', color: '#3fb950' },
            { name: 'Bonds', color: '#58a6ff' },
            { name: 'Real Estate', color: '#d29922' },
            { name: 'Cash', color: '#8b949e' },
            { name: 'Crypto', color: '#a371f7' },
            { name: 'Gold', color: '#f0883e' }
        ];

        const ROUND_TIME = 12000;
        const TOTAL_ROUNDS = 10;

        let score = 0;
        let displayedScore = 0;
        let round = 1;
        let combo = 0;
        let best = parseInt(localStorage.getItem('portfolioBalancerBest')) || 0;
        let assets = [];
        let targetAllocation = [];
        let currentAllocation = [];
        let timerStart = null;
        let animationId = null;
        let gameActive = false;
        let lastTickValue = 0;

        const currentChartCanvas = document.getElementById('current-chart');
        const targetChartCanvas = document.getElementById('target-chart');
        const currentCtx = currentChartCanvas.getContext('2d');
        const targetCtx = targetChartCanvas.getContext('2d');

        function animateValue(el, start, end, duration = 400) {
            const startTime = performance.now();
            function update(now) {
                const progress = Math.min((now - startTime) / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (end - start) * eased);
                el.textContent = current;
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        function setupRound() {
            const numAssets = Math.min(3 + Math.floor(round / 3), 6);
            assets = ASSET_CLASSES.slice(0, numAssets);
            targetAllocation = generateAllocation(numAssets);
            currentAllocation = generateAllocation(numAssets);
            lastTickValue = 0;

            renderSliders();
            updateCharts();
            updateAccuracy();

            document.getElementById('accuracy-section').classList.remove('perfect', 'close');
            document.getElementById('accuracy-badge').classList.remove('show');
            document.getElementById('current-box').classList.remove('match');
        }

        function generateAllocation(n) {
            const allocation = [];
            let remaining = 100;

            for (let i = 0; i < n - 1; i++) {
                const max = remaining - (n - i - 1) * 5;
                const min = 5;
                const value = Math.floor(Math.random() * (max - min + 1)) + min;
                allocation.push(value);
                remaining -= value;
            }
            allocation.push(remaining);

            for (let i = allocation.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allocation[i], allocation[j]] = [allocation[j], allocation[i]];
            }

            return allocation;
        }

        function renderSliders() {
            const container = document.getElementById('sliders');
            container.innerHTML = '';

            assets.forEach((asset, i) => {
                const row = document.createElement('div');
                row.className = 'slider-row';
                row.id = 'slider-row-' + i;

                const targetPercent = targetAllocation[i];

                row.innerHTML = `
                    <div class="slider-color" style="background-color: ${asset.color};"></div>
                    <div class="slider-label">${asset.name}</div>
                    <div class="slider-container">
                        <div class="slider-target-marker" style="left: calc(${targetPercent}% - 2px);"></div>
                        <input type="range" min="0" max="100" value="${currentAllocation[i]}"
                               data-index="${i}"
                               style="--color: ${asset.color}; --value: ${currentAllocation[i]}%;">
                    </div>
                    <div class="slider-values">
                        <span class="slider-current" id="current-${i}">${currentAllocation[i]}%</span>
                        <span class="slider-target-val">/${targetAllocation[i]}%</span>
                    </div>
                `;

                container.appendChild(row);

                const slider = row.querySelector('input[type="range"]');
                slider.addEventListener('input', (e) => {
                    handleSliderChange(i, parseInt(e.target.value));
                });
            });
        }

        function handleSliderChange(index, value) {
            initAudio();

            const oldValue = currentAllocation[index];
            const diff = value - oldValue;

            if (diff === 0) return;

            // Play tick sound
            if (Math.abs(value - lastTickValue) >= 2) {
                playTick();
                lastTickValue = value;
            }

            currentAllocation[index] = value;

            let total = currentAllocation.reduce((a, b) => a + b, 0);
            let excess = total - 100;

            if (excess !== 0) {
                const others = assets.map((_, i) => i).filter(i => i !== index);
                let attempts = 0;

                while (excess !== 0 && attempts < 100) {
                    for (const i of others) {
                        if (excess === 0) break;
                        if (excess > 0 && currentAllocation[i] > 0) {
                            currentAllocation[i] -= 1;
                            excess -= 1;
                        } else if (excess < 0 && currentAllocation[i] < 100) {
                            currentAllocation[i] += 1;
                            excess += 1;
                        }
                    }
                    attempts++;
                }
            }

            // Update all sliders
            assets.forEach((_, i) => {
                const slider = document.querySelector(`input[data-index="${i}"]`);
                if (slider) {
                    slider.value = currentAllocation[i];
                    slider.style.setProperty('--value', currentAllocation[i] + '%');
                    document.getElementById(`current-${i}`).textContent = currentAllocation[i] + '%';

                    // Check if on target
                    const row = document.getElementById('slider-row-' + i);
                    const diff = Math.abs(currentAllocation[i] - targetAllocation[i]);
                    row.classList.remove('on-target', 'close-target');
                    if (diff === 0) {
                        row.classList.add('on-target');
                    } else if (diff <= 5) {
                        row.classList.add('close-target');
                    }
                }
            });

            updateCharts();
            updateAccuracy();
        }

        function drawPieChart(ctx, allocation, colors, highlight = false) {
            const centerX = 60;
            const centerY = 60;
            const radius = 55;

            ctx.clearRect(0, 0, 120, 120);

            let startAngle = -Math.PI / 2;

            allocation.forEach((percent, i) => {
                const sliceAngle = (percent / 100) * Math.PI * 2;

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[i];
                ctx.fill();

                if (highlight) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                startAngle += sliceAngle;
            });

            // Center hole
            ctx.beginPath();
            ctx.arc(centerX, centerY, 22, 0, Math.PI * 2);
            ctx.fillStyle = '#161b22';
            ctx.fill();
        }

        function updateCharts() {
            const colors = assets.map(a => a.color);
            drawPieChart(currentCtx, currentAllocation, colors, true);
            drawPieChart(targetCtx, targetAllocation, colors, false);
        }

        function updateAccuracy() {
            let totalDiff = 0;
            for (let i = 0; i < assets.length; i++) {
                totalDiff += Math.abs(currentAllocation[i] - targetAllocation[i]);
            }
            const accuracy = Math.max(0, 100 - totalDiff);

            const accEl = document.getElementById('accuracy');
            const accBar = document.getElementById('accuracy-bar');
            const accSection = document.getElementById('accuracy-section');
            const accBadge = document.getElementById('accuracy-badge');

            accEl.textContent = accuracy + '%';
            accBar.style.width = accuracy + '%';

            accSection.classList.remove('perfect', 'close');
            accBadge.classList.remove('show', 'perfect', 'close');

            if (accuracy === 100) {
                accEl.className = 'accuracy-value perfect';
                accBar.style.backgroundColor = '#3fb950';
                accSection.classList.add('perfect');
                accBadge.textContent = 'âœ¨ PERFECT!';
                accBadge.classList.add('show', 'perfect');
                document.getElementById('current-box').classList.add('match');
            } else if (accuracy >= 90) {
                accEl.className = 'accuracy-value high';
                accBar.style.backgroundColor = '#3fb950';
                accSection.classList.add('close');
                accBadge.textContent = 'ðŸŽ¯ CLOSE!';
                accBadge.classList.add('show', 'close');
                document.getElementById('current-box').classList.remove('match');
            } else if (accuracy >= 70) {
                accEl.className = 'accuracy-value medium';
                accBar.style.backgroundColor = '#d29922';
                document.getElementById('current-box').classList.remove('match');
            } else {
                accEl.className = 'accuracy-value low';
                accBar.style.backgroundColor = '#f85149';
                document.getElementById('current-box').classList.remove('match');
            }

            return accuracy;
        }

        function startTimer() {
            const timeLimit = Math.max(6000, ROUND_TIME - (round - 1) * 400);
            timerStart = Date.now();

            function tick() {
                if (!gameActive) return;

                const elapsed = Date.now() - timerStart;
                const remaining = Math.max(0, 1 - elapsed / timeLimit);

                const timerEl = document.getElementById('timer');
                timerEl.style.width = (remaining * 100) + '%';

                if (remaining < 0.2) {
                    timerEl.className = 'timer-fill danger';
                } else if (remaining < 0.4) {
                    timerEl.className = 'timer-fill warning';
                } else {
                    timerEl.className = 'timer-fill';
                }

                if (remaining > 0) {
                    animationId = requestAnimationFrame(tick);
                } else {
                    submitAllocation();
                }
            }

            tick();
        }

        function submitAllocation() {
            if (!gameActive) return;
            gameActive = false;
            cancelAnimationFrame(animationId);

            const accuracy = updateAccuracy();

            let roundScore = 0;
            let feedback = '';
            let flashType = 'ok';

            if (accuracy === 100) {
                roundScore = 200 * round;
                feedback = 'PERFECT!';
                flashType = 'good';
                combo++;
                if (combo > 1) roundScore = Math.floor(roundScore * (1 + combo * 0.25));
                playPerfect();
                confetti(60);
            } else if (accuracy >= 95) {
                roundScore = 150 * round;
                feedback = 'Excellent!';
                flashType = 'good';
                combo++;
                if (combo > 1) roundScore = Math.floor(roundScore * (1 + combo * 0.2));
                playSuccess();
                confetti(30);
            } else if (accuracy >= 85) {
                roundScore = 100 * round;
                feedback = 'Great!';
                flashType = 'good';
                combo = 0;
                playSuccess();
            } else if (accuracy >= 70) {
                roundScore = 50 * round;
                feedback = 'Good';
                flashType = 'ok';
                combo = 0;
                playClick();
            } else {
                roundScore = 0;
                feedback = 'Miss!';
                flashType = 'bad';
                combo = 0;
                playError();
            }

            screenFlash(flashType);

            score += roundScore;

            // Update score with animation
            const scoreEl = document.getElementById('score');
            animateValue(scoreEl, displayedScore, score, 500);
            displayedScore = score;
            document.getElementById('score-stat').classList.add('highlight');
            setTimeout(() => document.getElementById('score-stat').classList.remove('highlight'), 400);

            // Show result
            const resultEl = document.getElementById('round-result');
            resultEl.textContent = roundScore > 0 ? `+${roundScore}` : feedback;
            resultEl.className = 'round-result show ' + (accuracy >= 85 ? 'good' : accuracy >= 50 ? 'ok' : 'bad');

            // Update combo display
            const comboEl = document.getElementById('combo-display');
            if (combo >= 2) {
                comboEl.textContent = 'ðŸŽ¯ x' + combo + ' Combo!';
                comboEl.classList.add('show');
            } else {
                comboEl.classList.remove('show');
            }

            setTimeout(() => {
                resultEl.classList.remove('show');
                resultEl.style.transform = 'translate(-50%, -50%) scale(0)';

                if (round >= TOTAL_ROUNDS) {
                    endGame();
                } else {
                    round++;
                    document.getElementById('round').textContent = round + '/' + TOTAL_ROUNDS;
                    setupRound();
                    gameActive = true;
                    startTimer();
                }
            }, 1500);
        }

        function endGame() {
            if (score > best) {
                best = score;
                localStorage.setItem('portfolioBalancerBest', score);
                document.getElementById('best').textContent = best;
                confetti(80);
            }

            const title = document.getElementById('gameover-title');
            if (score >= 2000) {
                title.textContent = 'ðŸ† Portfolio Master!';
                title.className = 'overlay-title win';
            } else if (score >= 1000) {
                title.textContent = 'ðŸ“ˆ Well Balanced!';
                title.className = 'overlay-title win';
            } else {
                title.textContent = 'ðŸ“Š Keep Practicing';
                title.className = 'overlay-title lose';
            }

            document.getElementById('gameover-subtitle').textContent = `Final Score: ${score}`;
            document.getElementById('gameover-overlay').classList.add('active');
        }

        function startGame() {
            initAudio();
            score = 0;
            displayedScore = 0;
            round = 1;
            combo = 0;

            document.getElementById('score').textContent = score;
            document.getElementById('round').textContent = '1/' + TOTAL_ROUNDS;
            document.getElementById('best').textContent = best;
            document.getElementById('timer').style.width = '100%';
            document.getElementById('timer').className = 'timer-fill';
            document.getElementById('combo-display').classList.remove('show');

            document.getElementById('start-overlay').classList.remove('active');
            document.getElementById('gameover-overlay').classList.remove('active');

            setupRound();
            gameActive = true;
            startTimer();
        }

        // Event Listeners
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('restart-btn').addEventListener('click', startGame);
        document.getElementById('submit-btn').addEventListener('click', submitAllocation);

        // Initialize display
        document.getElementById('best').textContent = best;
    </script>
</body>
</html>
